<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CoinDCX Auto Trader + SMC (with Charts)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { padding: 20px; background: #0f172a; color: #e2e8f0; }
    .card { background: #111827; border-color: #1f2937; }
    .card-header { background: #0b1220; border-bottom-color: #1f2937; }
    .badge { font-size: 0.85rem; }
    .blink { animation: blinker 0.7s linear infinite; color: #ef4444; font-weight: 700; }
    @keyframes blinker { 50% { opacity: 0; } }
    pre { white-space: pre-wrap; word-break: break-word; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .muted { color: #9ca3af; }
    .good { color: #22c55e; }
    .bad { color: #ef4444; }
    .chip { background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:.35rem .6rem;margin:.25rem;display:inline-block }
    a, a:visited { color: #60a5fa; }
    .smc-item { padding:10px;border-bottom:1px solid #1f2937; }
    .smc-head { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .smc-title { font-weight:600; }
    .smc-sub { font-size:.9rem; color:#9ca3af; }
    .spark { width:100%; height:90px; }
  </style>
</head>
<body>
  <div class="container-xxl">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="mb-0">CoinDCX Auto Trading Dashboard <span class="badge bg-secondary">SMC + PA + Charts</span></h3>
      <div>
        <button class="btn btn-success me-2" onclick="startScan()">Start</button>
        <button class="btn btn-danger" onclick="stopScan()">Stop</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header"><strong>Runtime</strong></div>
          <div class="card-body">
            <div class="mb-2">Status: <span id="status" class="badge bg-info text-dark">-</span></div>
            <div class="mb-2">Last Updated: <span id="last" class="mono muted">-</span></div>
            <div class="mb-2">USDT Balance: <span id="usdt" class="mono good">0</span></div>
            <div class="mb-2">Profit Today: <span id="profitToday" class="mono">0</span></div>
            <div>Profit Yesterday: <span id="profitYesterday" class="mono muted">0</span></div>
            <div id="errorBox" class="mt-3 blink" style="display:none;">
              ⚠️ Order Failed: <span id="errorMsg" class="mono"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card h-100">
          <div class="card-header"><strong>Coin Balances</strong></div>
          <div class="card-body">
            <div id="coinChips" class="mono"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-xl-7">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Recent Trades</strong>
            <small class="muted">Latest 10</small>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-dark table-striped table-sm align-middle mb-0">
                <thead>
                  <tr class="muted">
                    <th>Time</th><th>Pair</th><th>Side</th><th>Qty</th><th>Entry</th><th>TP</th><th>SL</th><th>Message</th>
                  </tr>
                </thead>
                <tbody id="tradeTable" class="mono"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xl-5">
        <div class="card h-100">
          <div class="card-header"><strong>Scan Logs</strong></div>
          <div class="card-body">
            <pre id="scanLogs" class="mono" style="height:320px; overflow-y:auto; background:#0b1220; border:1px solid #1f2937; padding:10px; border-radius:.5rem;"></pre>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header"><strong>SMC — Buy Zones</strong></div>
          <div class="card-body" id="buy-list"></div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header"><strong>SMC — Sell Zones</strong></div>
          <div class="card-body" id="sell-list"></div>
        </div>
      </div>
    </div>

    <p class="mt-4 muted small">Program ID: <strong>ABCD</strong></p>
  </div>

  <script>
    async function startScan() {
      try {
        const r = await fetch('/start', { method: 'POST' });
        const data = await r.json();
        document.getElementById("status").innerText = data.status || "-";
      } catch (e) { console.error(e); }
    }

    async function stopScan() {
      try {
        const r = await fetch('/stop', { method: 'POST' });
        const data = await r.json();
        document.getElementById("status").innerText = data.status || "-";
      } catch (e) { console.error(e); }
    }

    async function refreshData() {
      try {
        const r = await fetch('/status');
        const data = await r.json();

        document.getElementById("status").innerText = data.status ?? "-";
        document.getElementById("last").innerText = data.last ?? "-";
        document.getElementById("usdt").innerText = (data.usdt ?? 0).toFixed ? (data.usdt).toFixed(2) : data.usdt;
        document.getElementById("profitToday").innerText = data.profit_today ?? 0;
        document.getElementById("profitYesterday").innerText = data.profit_yesterday ?? 0;

        // Coin chips
        const chips = document.getElementById("coinChips");
        chips.innerHTML = "";
        if (data.coins) {
          Object.entries(data.coins).forEach(([coin, bal]) => {
            const span = document.createElement("span");
            span.className = "chip mono";
            span.textContent = `${coin}: ${bal}`;
            chips.appendChild(span);
          });
        }

        // Trades
        const tbody = document.getElementById("tradeTable");
        tbody.innerHTML = "";
        (data.trades || []).forEach(t => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="mono">${t.time || "-"}</td>
            <td class="mono">${t.pair || "-"}</td>
            <td class="${t.side === 'BUY' ? 'good' : 'bad'} mono">${t.side || "-"}</td>
            <td class="mono">${t.qty ?? "-"}</td>
            <td class="mono">${t.entry ?? "-"}</td>
            <td class="mono">${t.tp ?? "-"}</td>
            <td class="mono">${t.sl ?? "-"}</td>
            <td class="mono">${t.msg || "-"}</td>`;
          tbody.appendChild(tr);
        });

        // Scan logs
        const logs = data.scans || [];
        document.getElementById("scanLogs").innerText = logs.join("\n");

        // Error banner
        if (data.error && String(data.error).length > 0) {
          document.getElementById("errorBox").style.display = "block";
          document.getElementById("errorMsg").innerText = data.error;
        } else {
          document.getElementById("errorBox").style.display = "none";
        }
      } catch (e) {
        console.error("refreshData error:", e);
      }
    }

    // --- SMC + Charts ---
    const charts = new Map();     // symbol => Chart instance
    const series = new Map();     // symbol => { labels:[], data:[] }
    const MAX_POINTS = 60;        // keep up to 60 minutes of prices

    function upsertSparkline(container, symbol, price) {
      // Ensure a canvas exists for this symbol
      let canvas = container.querySelector(`canvas[data-sym="${symbol}"]`);
      if (!canvas) {
        const wrap = document.createElement("div");
        wrap.className = "smc-item";
        wrap.innerHTML = `
          <div class="smc-head">
            <div class="smc-title">${symbol}</div>
            <div class="smc-sub mono">Last: ${price}</div>
          </div>
          <canvas class="spark" data-sym="${symbol}"></canvas>
          <div class="smc-sub mono detail" data-detail="${symbol}"></div>
        `;
        container.appendChild(wrap);
        canvas = wrap.querySelector("canvas");
      } else {
        // update last price label
        const sub = container.querySelector(`.smc-sub.mono.detail[data-detail="${symbol}"]`);
        if (sub) sub.previousElementSibling.previousElementSibling.querySelector(".smc-sub.mono")?.remove;
      }

      // Prepare series
      if (!series.has(symbol)) {
        series.set(symbol, { labels: [], data: [] });
      }
      const s = series.get(symbol);
      const ts = new Date();
      s.labels.push(ts.toLocaleTimeString());
      s.data.push(price);
      if (s.labels.length > MAX_POINTS) {
        s.labels.shift(); s.data.shift();
      }

      // Build/update chart
      if (!charts.has(symbol)) {
        const ctx = canvas.getContext("2d");
        const chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: s.labels,
            datasets: [{
              data: s.data,
              fill: false,
              tension: 0.2,
              pointRadius: 0
            }]
          },
          options: {
            responsive: true,
            animation: false,
            plugins: { legend: { display: false }, tooltip: { enabled: true } },
            scales: {
              x: { display: false },
              y: { display: true, ticks: { color: "#9ca3af", callback: v => v } , grid:{color:"#1f2937"} }
            }
          }
        });
        charts.set(symbol, chart);
      } else {
        const chart = charts.get(symbol);
        chart.data.labels = s.labels;
        chart.data.datasets[0].data = s.data;
        chart.update();
      }
    }

    function smcRowHTML(symbol, info) {
      const zoneTxt = info.zone ? `${info.zone[0]}–${info.zone[1]}` : "-";
      const rsi = info.rsi14 ?? info.rsi ?? "-";
      return `
        <div class="smc-head">
          <div>
            <div class="smc-title">${symbol} <span class="badge ${String(info.status||'').toLowerCase().includes('buy') ? 'bg-success' : 'bg-danger'}">${info.status || '-'}</span></div>
            <div class="smc-sub">EMA20: ${info.ema20} | EMA50: ${info.ema50} | RSI: ${rsi} | Trend: ${info.trend || '-'}</div>
            <div class="smc-sub">Zone: ${zoneTxt}</div>
          </div>
          <div class="smc-sub mono">₹${info.price}</div>
        </div>
      `;
    }

    async function fetchSMC() {
      try {
        const res = await fetch('/api/smc-status');
        const data = await res.json();

        const buyList = document.getElementById('buy-list');
        const sellList = document.getElementById('sell-list');
        buyList.innerHTML = '';
        sellList.innerHTML = '';

        if (data && typeof data === 'object' && !Array.isArray(data)) {
          // Render Buy/Sell sections with charts
          for (const [symbol, info] of Object.entries(data)) {
            if (!info || typeof info.price === "undefined") continue;

            const block = document.createElement("div");
            block.className = "smc-item";
            block.innerHTML = smcRowHTML(symbol, info);

            const canvas = document.createElement("canvas");
            canvas.className = "spark";
            canvas.dataset.sym = symbol;
            block.appendChild(canvas);

            const container = (String(info.status||'').toLowerCase().includes("buy")) ? buyList : sellList;
            container.appendChild(block);

            // Update/append series point & chart
            upsertSparkline(container, symbol, Number(info.price));
          }
        }

        // Fallback: if API returns {scans: []}, render logs into Sell list to show something
        if (Array.isArray(data?.scans) && data.scans.length) {
          data.scans.forEach(line => {
            const div = document.createElement('div');
            div.className = "smc-item";
            div.textContent = line;
            sellList.appendChild(div);
          });
        }
      } catch (e) {
        console.error("fetchSMC error:", e);
      }
    }

    // Pollers
    setInterval(refreshData, 5000);
    refreshData();

    setInterval(fetchSMC, 60000);
    fetchSMC();

    // Auto-start ping every 10 minutes to keep server alive
    setInterval(() => {
      fetch('/start', { method: 'POST' })
        .then(r => r.json())
        .then(d => console.log("Auto-start:", d.status))
        .catch(console.error);
    }, 600000);
  </script>
</body>
</html>
