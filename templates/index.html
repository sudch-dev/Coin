<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EMA+MACD Bot — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background:#0b0f14; color:#e6edf3;}
    h1,h2,h3 { margin: 0 0 8px; }
    .row { display:flex; flex-wrap: wrap; gap:16px; }
    .card { background:#111826; border:1px solid #1f2a3a; border-radius:10px; padding:14px; flex:1 1 340px; min-width:320px; }
    .kpis { display:grid; grid-template-columns: repeat(4, minmax(120px,1fr)); gap:10px; }
    .kpi { background:#0e1521; border:1px solid #1f2a3a; border-radius:8px; padding:10px; }
    .kpi .v { font-size: 18px; font-weight: 700; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #1e2635; padding:8px; text-align:left; font-size: 13px; }
    th { color:#93a4b9; font-weight:600; }
    .ok { color:#00d084; }
    .bad { color:#ff6b6b; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .btn { background:#1a2635; border:1px solid #2a3a52; color:#e6edf3; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn:hover { background:#223246; }
    small { color:#8ca0b8; }
    pre { white-space: pre-wrap; word-break: break-word; font-size:12px; line-height:1.35; }
  </style>
</head>
<body>
  <h1>EMA+MACD Bot <small class="mono" id="statustxt"></small></h1>

  <div class="row" style="margin-top:12px;">
    <div class="card">
      <h3>Controls</h3>
      <div style="display:flex; gap:10px; margin-top:8px;">
        <button class="btn" onclick="start()">Start</button>
        <button class="btn" onclick="stop()">Stop</button>
        <button class="btn" onclick="refresh()">Refresh</button>
      </div>
      <div style="margin-top:10px;">
        <small>Last update: <span id="last"></span></small>
      </div>
    </div>

    <div class="card">
      <h3>Keepalive</h3>
      <div class="mono" id="keepalive"></div>
      <div style="margin-top:6px;">
        <small>Ping URL: <span class="mono" id="pingurl"></span></small>
      </div>
    </div>

    <div class="card">
      <h3>Balances & PnL</h3>
      <div class="kpis" style="margin-top:8px;">
        <div class="kpi"><div>USDT</div><div class="v mono" id="usdt">-</div></div>
        <div class="kpi"><div>Today P&L</div><div class="v mono" id="pnl_today">-</div></div>
        <div class="kpi"><div>Yesterday</div><div class="v mono" id="pnl_yday">-</div></div>
        <div class="kpi"><div>Cumulative</div><div class="v mono" id="pnl_cum">-</div></div>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:16px;">
    <div class="card">
      <h3>Coin Balances</h3>
      <table id="coins_tbl">
        <thead><tr><th>Coin</th><th>Balance</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card">
      <h3>Open TP Orders</h3>
      <table id="tp_tbl">
        <thead><tr><th>Pair</th><th>Qty</th><th>Limit Px</th><th>Since</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="row" style="margin-top:16px;">
    <div class="card">
      <h3>Recent Trades</h3>
      <table id="trades_tbl">
        <thead><tr><th>Time</th><th>Pair</th><th>Side</th><th>Qty</th><th>Price</th><th>Realized</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card">
      <h3>Scan Log</h3>
      <pre id="scanlog" class="mono" style="max-height:420px; overflow:auto;">loading…</pre>
    </div>
  </div>

  <div class="row" style="margin-top:16px;">
    <div class="card">
      <h3>Errors</h3>
      <pre id="errors" class="mono">-</pre>
    </div>
  </div>

<script>
async function api(path, opts={}) {
  const r = await fetch(path, {cache:'no-store', ...opts});
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}
function fmt(n, d=6){ if(n===null||n===undefined) return '-'; const f=Number(n); if(isNaN(f)) return n; return f.toFixed(d); }

async function refresh(){
  try{
    const s = await api('/status');
    document.getElementById('statustxt').textContent = `(${s.status} • ${s.last})`;
    document.getElementById('last').textContent = s.last || '-';
    document.getElementById('usdt').textContent = fmt(s.usdt, 2);
    document.getElementById('pnl_today').textContent = fmt(s.profit_today, 4);
    document.getElementById('pnl_yday').textContent = fmt(s.profit_yesterday, 4);
    document.getElementById('pnl_cum').textContent = fmt(s.pnl_cumulative, 4);

    // keepalive
    const ka = s.keepalive || {};
    const pingurl = ka.token_present ? (ka.app_base_url + '/ping?t=' + '****') : (ka.app_base_url + '/ping');
    document.getElementById('pingurl').textContent = pingurl;
    document.getElementById('keepalive').innerHTML =
      `token_present: <b>${ka.token_present}</b><br>`+
      `interval_sec: <b>${ka.interval_sec ?? '-'}</b><br>`+
      `self_daemon: <b>${ka.self_daemon}</b><br>`+
      `last_ping_age_sec: <b>${ka.last_ping_age_sec ?? '-'}</b><br>`+
      `next_due_sec: <b>${ka.next_due_sec ?? '-'}</b>`;

    // coins
    const tbodyC = document.querySelector('#coins_tbl tbody');
    tbodyC.innerHTML = '';
    Object.entries(s.coins || {}).forEach(([coin,bal])=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${coin}</td><td class="mono">${fmt(bal,8)}</td>`;
      tbodyC.appendChild(tr);
    });

    // TP orders
    const tbodyT = document.querySelector('#tp_tbl tbody');
    tbodyT.innerHTML = '';
    Object.entries(s.tp_orders || {}).forEach(([pair,info])=>{
      const since = info.ts ? new Date(info.ts*1000).toLocaleTimeString() : '-';
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${pair}</td><td class="mono">${fmt(info.qty,8)}</td><td class="mono">${fmt(info.px,8)}</td><td class="mono">${since}</td>`;
      tbodyT.appendChild(tr);
    });

    // trades
    const tbt = document.querySelector('#trades_tbl tbody');
    tbt.innerHTML='';
    (s.trades||[]).forEach(t=>{
      const pnlClass = (t.realized>=0) ? 'ok' : 'bad';
      const tr=document.createElement('tr');
      tr.innerHTML =
        `<td class="mono">${t.time}</td>`+
        `<td>${t.pair}</td>`+
        `<td>${t.side}</td>`+
        `<td class="mono">${fmt(t.qty,8)}</td>`+
        `<td class="mono">${fmt(t.price,8)}</td>`+
        `<td class="mono ${pnlClass}">${fmt(t.realized,6)}</td>`;
      tbt.appendChild(tr);
    });

    // scan logs
    document.getElementById('scanlog').textContent = (s.scans||[]).join('\n') || '-';

    // errors
    document.getElementById('errors').textContent = s.error || '-';
  } catch(e){
    document.getElementById('errors').textContent = String(e);
  }
}

async function start(){ try{ await api('/start', {method:'POST'}); refresh(); }catch(e){ alert(e); } }
async function stop(){ try{ await api('/stop',  {method:'POST'}); refresh(); }catch(e){ alert(e); } }

refresh();
setInterval(refresh, 2000);
</script>
</body>
</html>
