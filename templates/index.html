<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard</title>
  <style>
    :root { --bg:#0f141a; --panel:#18202a; --ink:#e6f1ff; --muted:#9fb3c8; --ok:#65d6ad; --warn:#ffb454; --bad:#ff6b6b; }
    html,body { margin:0; background:var(--bg); color:var(--ink); font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; }
    .wrap { max-width:980px; margin:0 auto; padding:20px 16px 80px; }
    h1 { font-size:28px; margin:6px 0 14px; }
    .pill { display:inline-block; padding:8px 12px; border-radius:999px; background:#121821; color:var(--muted); margin:8px 8px 8px 0; font-size:14px; border:1px solid #223041; }
    .grid { display:grid; grid-template-columns: 1fr; gap:18px; }
    .card { background:var(--panel); border:1px solid #223041; border-radius:14px; padding:16px; }
    .card h2 { margin:0 0 12px; font-size:22px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap; }
    .muted { color:var(--muted); }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 8px; border-bottom:1px solid #223041; text-align:left; }
    th { color:#b3c7dc; font-weight:600; }
    .footer { text-align:center; color:var(--muted); margin-top:24px; }
    .btn { background:#223041; border:1px solid #2c3d52; color:#d2e6ff; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .ok { color:var(--ok); }
    .bad{ color:var(--bad); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Market Maker Dashboard</h1>
    <div class="row">
      <span class="pill">TP: 0.5% · No SL</span>
      <span id="ka" class="pill">Auto-scan: loading…</span>
      <button id="start" class="btn pill">Start</button>
      <button id="stop" class="btn pill">Stop</button>
      <span id="status" class="pill">Status: —</span>
    </div>

    <div class="card">
      <h2>Signal Log</h2>
      <div id="scan" class="mono muted">loading…</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Balances</h2>
        <div id="bal" class="mono muted">loading…</div>
      </div>

      <div class="card">
        <h2>Open TP Orders</h2>
        <table>
          <thead><tr><th>Pair</th><th>Qty</th><th>Limit Px</th><th>Since</th></tr></thead>
          <tbody id="tp"></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Recent Trades</h2>
        <table>
          <thead><tr><th>Time</th><th>Pair</th><th>Side</th><th>Qty</th><th>Price</th><th>Realized</th></tr></thead>
          <tbody id="trades"></tbody>
        </table>
      </div>

      <div class="card">
        <h2>P&amp;L</h2>
        <div id="pnl" class="mono"></div>
      </div>

      <div class="card">
        <h2>Errors</h2>
        <div id="err" class="mono muted">-</div>
      </div>
    </div>

    <div class="footer">© 2025 MM Bot · Logs update live.</div>
  </div>

  <script>
    const scanBox = document.getElementById('scan');
    const balBox  = document.getElementById('bal');
    const pnlBox  = document.getElementById('pnl');
    const tpBody  = document.getElementById('tp');
    const trBody  = document.getElementById('trades');
    const errBox  = document.getElementById('err');
    const kaPill  = document.getElementById('ka');
    const statusP = document.getElementById('status');

    function tsToStr(ts){
      if(!ts) return '-';
      const d = new Date(ts*1000);
      return d.toLocaleString();
    }

    async function fetchStatus(){
      try{
        const r = await fetch('/status', {cache:'no-store'});
        const j = await r.json();

        statusP.textContent = `Status: ${j.status} · ${j.last || ''}`;

        // keepalive pill
        const ka = j.keepalive || {};
        const every = (ka.poll_sec ? `${ka.poll_sec}s` : '—');
        const lastAge = (ka.last_ping_age_sec!=null) ? `${ka.last_ping_age_sec}s ago` : '—';
        const nextDue = (ka.next_due_sec!=null) ? `${ka.next_due_sec}s` : '—';
        kaPill.textContent = `Auto-scan: every ${every} · Keepalive ${ka.enabled ? 'ON' : 'OFF'} · last ${lastAge} · next ${nextDue}`;

        // scan log
        const lines = (j.scans || []).slice().reverse().join('\n');
        scanBox.textContent = lines || '—';

        // balances
        const coins = j.coins || {};
        let b = `USDT: ${Number(j.usdt||0).toFixed(8)}\n\n`;
        Object.keys(coins).sort().forEach(k=>{
          b += `${k.padEnd(4,' ')}: ${Number(coins[k]||0).toFixed(8)}\n`;
        });
        balBox.textContent = b;

        // pnl
        pnlBox.textContent =
          `Today: ${j.profit_today}\nYesterday: ${j.profit_yesterday}\nCumulative: ${j.pnl_cumulative}`;

        // TP table
        tpBody.innerHTML = '';
        const tps = j.tp_orders || {};
        const fmt = (x, d=8)=> Number(x||0).toFixed(d);
        Object.keys(tps).forEach(pair=>{
          const o = tps[pair];
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${pair}</td>
            <td>${fmt(o.qty)}</td>
            <td>${o.px}</td>
            <td>${tsToStr(o.ts)}</td>`;
          tpBody.appendChild(tr);
        });
        if(Object.keys(tps).length===0){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="4" class="muted">No open TP orders.</td>`;
          tpBody.appendChild(tr);
        }

        // recent trades list (if you add to trade_log server-side)
        trBody.innerHTML = '';
        (j.trades||[]).forEach(t=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${t.time||'-'}</td>
            <td>${t.pair||'-'}</td>
            <td>${t.side||'-'}</td>
            <td>${t.qty||'-'}</td>
            <td>${t.price||'-'}</td>
            <td>${t.realized||'-'}</td>`;
          trBody.appendChild(tr);
        });
        if((j.trades||[]).length===0){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="6" class="muted">No recent trades.</td>`;
          trBody.appendChild(tr);
        }

        // errors
        errBox.textContent = j.error || '-';

      }catch(e){
        errBox.textContent = 'UI fetch failed: ' + e;
      }
    }

    // buttons
    document.getElementById('start').onclick = async ()=>{
      try{ await fetch('/start', {method:'POST'}); }catch{}
      fetchStatus();
    };
    document.getElementById('stop').onclick = async ()=>{
      try{ await fetch('/stop', {method:'POST'}); }catch{}
      fetchStatus();
    };

    // poll
    fetchStatus();
    setInterval(fetchStatus, 2000);
  </script>
</body>
</html>
