<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EMA+MACD Trader (5s) — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; color: #111; }
    h1 { margin: 0 0 6px; }
    .muted { color:#666; font-size:14px;}
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .card { border:1px solid #ddd; border-radius:10px; padding:14px; background:#fff; flex:1; min-width:280px; }
    .pill { display:inline-block; padding:4px 10px; border-radius:20px; background:#eef; margin-right:6px; font-size:12px; }
    button { padding:8px 14px; border-radius:8px; border:1px solid #333; background:#111; color:#fff; cursor:pointer; }
    button.secondary { background:#fff; color:#111; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; font-size:13px;}
    pre { background:#0b1020; color:#d4ffea; padding:12px; border-radius:8px; overflow:auto; max-height:420px; }
    .ok { color:#0a8f20; }
    .warn { color:#b36b00; }
  </style>
</head>
<body>
  <h1>EMA+MACD Trader</h1>
  <div class="muted">5s candles · TP ≥ 1% or Sell signal · No SL · Buy=30% USDT · Sell=full coin</div>
  <div style="margin:10px 0;">
    <span class="pill">EMA5 &gt; EMA10 + MACD bullish ⇒ BUY</span>
    <span class="pill">EMA5 &lt; EMA10 + MACD bearish ⇒ SELL</span>
    <span class="pill">MACD Convergence/Divergence logged</span>
  </div>

  <div style="margin:10px 0;">
    <button id="startBtn">Start</button>
    <button id="stopBtn" class="secondary">Stop Run</button>
    <button id="refreshBtn" class="secondary">Refresh</button>
  </div>

  <div class="row">
    <div class="card" style="max-width:360px">
      <h3>Status</h3>
      <div id="statusBox" class="muted">loading…</div>
      <h3 style="margin-top:16px;">Balances</h3>
      <div id="balBox" class="muted">loading…</div>
      <h3 style="margin-top:16px;">Keepalive</h3>
      <div id="keepBox" class="muted">loading…</div>
    </div>

    <div class="card">
      <h3>Open Positions</h3>
      <table id="posTable">
        <thead><tr><th>Pair</th><th>Qty</th><th>Entry</th><th>Time</th></tr></thead>
        <tbody></tbody>
      </table>
      <h3 style="margin-top:16px;">P&amp;L</h3>
      <div id="pnlBox" class="muted">loading…</div>
      <h3 style="margin-top:16px;">Trades</h3>
      <div id="tradesBox" class="muted">loading…</div>
    </div>

    <div class="card" style="flex-basis:100%;">
      <h3>Scan Log (signals, MACD C/D, gates)</h3>
      <pre id="logBox">loading…</pre>
    </div>
  </div>

  <script>
    async function api(path, opts={}) {
      const r = await fetch(path, opts);
      return r.json ? r.json() : r.text();
    }

    async function loadStatus() {
      const data = await api('/status');
      // status
      document.getElementById('statusBox').innerHTML =
        `<div><b>${data.status}</b> · last: ${data.last}</div>`;

      // balances + PNL
      document.getElementById('balBox').innerHTML =
        `<div>USDT: <b>${(data.usdt||0).toFixed(6)}</b></div>`;

      document.getElementById('pnlBox').innerHTML =
        `<div>Today: <b class="${data.profit_today>=0?'ok':'warn'}">${(data.profit_today||0).toFixed(6)}</b></div>
         <div>Cumulative: <b class="${data.pnl_cumulative>=0?'ok':'warn'}">${(data.pnl_cumulative||0).toFixed(6)}</b></div>`;

      // positions
      const posTbody = document.querySelector('#posTable tbody');
      posTbody.innerHTML = '';
      for (const [pair, v] of Object.entries(data.positions||{})) {
        const tr = document.createElement('tr');
        const dt = new Date((v.ts||0)*1000).toLocaleString();
        tr.innerHTML = `<td>${pair}</td><td>${v.qty}</td><td>${v.entry}</td><td>${dt}</td>`;
        posTbody.appendChild(tr);
      }

      // trades
      const trades = (data.trades||[]).map(x=>x).join('\n');
      document.getElementById('tradesBox').textContent = trades || '—';

      // logs
      const logs = (data.scans||[]).join('\n');
      document.getElementById('logBox').textContent = logs || '—';

      // keepalive box
      const k = data.keepalive || {};
      document.getElementById('keepBox').innerHTML =
        `<div>Enabled: <b>${k.enabled ? 'Yes' : 'No'}</b></div>
         <div>Interval: ${k.interval_sec||'-'}s</div>
         <div>Last ping age: ${k.last_ping_age_sec??'-'}s</div>
         <div>Next due in: ${k.next_due_sec??'-'}s</div>
         <div>URL: ${k.app_base_url || ''}/ping</div>`;
    }

    document.getElementById('startBtn').onclick = async () => {
      await api('/start', {method: 'POST'});
      loadStatus();
    };
    document.getElementById('stopBtn').onclick = async () => {
      await api('/stop', {method: 'POST'});
      loadStatus();
    };
    document.getElementById('refreshBtn').onclick = loadStatus;

    // auto-refresh
    loadStatus();
    setInterval(loadStatus, 4000);
  </script>
</body>
</html>
