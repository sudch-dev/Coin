<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <style>
    body {
      background-color: #000;
      color: #eee;
      font-family: monospace, sans-serif;
      margin: 0; padding: 0;
    }
    header {
      background: #111;
      padding: 10px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      color: #0f0;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      padding: 10px;
    }
    .panel {
      flex: 1 1 45%;
      margin: 10px;
      background: #111;
      border: 1px solid #333;
      border-radius: 5px;
      padding: 10px;
      overflow: auto;
      max-height: 400px;
    }
    h2 { font-size: 16px; margin: 0 0 5px 0; color: #0f0; }
    .btns { margin-bottom: 10px; }
    button {
      background: #222; color: #0f0; border: 1px solid #0f0;
      padding: 5px 10px; margin-right: 5px; cursor: pointer;
    }
    button:hover { background: #0f0; color: #000; }
    .pos { color: #0f0; }
    .neg { color: #f33; }
    .logline:nth-child(odd) { background: #181818; }
    .logline:nth-child(even) { background: #101010; }
    .error { color: #f33; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; }
    td { padding: 2px 4px; border-bottom: 1px solid #333; }
  </style>
</head>
<body>
  <header>Dashboard</header>
  <div class="container">
    <div class="panel" style="flex:1 1 100%;">
      <div class="btns">
        <button onclick="postJSON('/start')">Start</button>
        <button onclick="postJSON('/stop')">Stop</button>
        <span id="statusLine"></span>
      </div>
      <div class="error" id="err"></div>
    </div>

    <div class="panel">
      <h2>Balances</h2>
      <table id="balances"></table>
      <p>USDT: <span id="usdt"></span></p>
      <p>Profit Today: <span id="profitToday"></span></p>
      <p>Profit Yesterday: <span id="profitYesterday"></span></p>
      <p>Cumulative P&L: <span id="pnl"></span></p>
    </div>

    <div class="panel">
      <h2>Recent Trades</h2>
      <div id="trades"></div>
    </div>

    <div class="panel" style="flex:1 1 100%;">
      <h2>Scan Log</h2>
      <div id="scans"></div>
    </div>
  </div>

  <script>
    async function loadStatus(){
      try{
        const res = await fetch('/status');
        const data = await res.json();
        document.getElementById('statusLine').textContent =
          data.status + " | Last: " + data.last;

        // balances
        let tbl = "";
        for(const [coin, bal] of Object.entries(data.coins)){
          tbl += `<tr><td>${coin}</td><td>${bal}</td></tr>`;
        }
        document.getElementById('balances').innerHTML = tbl;
        document.getElementById('usdt').textContent = data.usdt.toFixed(2);
        document.getElementById('profitToday').textContent = data.profit_today;
        document.getElementById('profitYesterday').textContent = data.profit_yesterday;
        document.getElementById('pnl').textContent = data.pnl_cumulative;

        // trades
        const tdiv = document.getElementById('trades');
        tdiv.innerHTML = "";
        (data.trades||[]).forEach(t=>{
          const d = document.createElement('div');
          d.className = "logline";
          d.innerHTML = `<span class="${t.side==='BUY'?'pos':'neg'}">` +
                        `${t.time} | ${t.pair} | ${t.side} | ${t.entry} | qty=${t.qty} | SL=${t.sl} | TP=${t.tp}</span>`;
          tdiv.appendChild(d);
        });

        // scans
        const sdiv = document.getElementById('scans');
        sdiv.innerHTML = "";
        (data.scans||[]).forEach(l=>{
          const d = document.createElement('div');
          d.className = "logline";
          if(l.includes("SELL")) d.innerHTML = `<span class="neg">${l}</span>`;
          else if(l.includes("BUY")) d.innerHTML = `<span class="pos">${l}</span>`;
          else d.textContent = l;
          sdiv.appendChild(d);
        });

        document.getElementById('err').textContent = data.error||"";
      }catch(e){
        document.getElementById('err').textContent = "Error fetching /status: " + e;
      }
    }

    async function postJSON(url){
      try{
        await fetch(url, {method:'POST'});
        loadStatus();
      }catch(e){
        document.getElementById('err').textContent = "Error: " + e;
      }
    }

    setInterval(loadStatus, 5000);
    loadStatus();
  </script>
</body>
</html>
