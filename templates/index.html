<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Algo Bot Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f6f8fa; margin: 0; padding: 0; }
    header { background: #24292e; color: white; padding: 12px; font-size: 20px; }
    .pill { background: #0366d6; color: white; border-radius: 10px; padding: 3px 8px; font-size: 12px; }
    .container { padding: 20px; }
    button { margin: 5px; padding: 8px 14px; font-size: 14px; cursor: pointer; border: none; border-radius: 4px; }
    button.start { background: #28a745; color: white; }
    button.stop { background: #d73a49; color: white; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px; font-size: 13px; }
    th { background: #f1f1f1; }
    .log-box { background: #111; color: #0f0; font-family: monospace; padding: 10px; height: 260px; overflow-y: scroll; white-space: pre-wrap; }
  </style>
</head>
<body>
  <header>
    Algo Bot Dashboard
    <span class="pill">TP: 1.0% Â· No SL</span>
  </header>
  <div class="container">
    <div>
      <button class="start" onclick="controlBot('start')">Start Bot</button>
      <button class="stop" onclick="controlBot('stop')">Stop Bot</button>
    </div>

    <h3>Status</h3>
    <pre id="statusBox">Loading...</pre>

    <h3>Positions</h3>
    <table id="positionsTable">
      <thead><tr><th>Pair</th><th>Entry</th><th>Qty</th></tr></thead>
      <tbody></tbody>
    </table>

    <h3>Trades</h3>
    <table id="tradesTable">
      <thead><tr><th>Time</th><th>Pair</th><th>Side</th><th>Qty</th><th>Price</th><th>Reason</th></tr></thead>
      <tbody></tbody>
    </table>

    <h3>Scan Logs</h3>
    <div class="log-box" id="logBox"></div>
  </div>

<script>
async function refreshStatus(){
  try{
    const r = await fetch('/status');
    const j = await r.json();
    document.getElementById('statusBox').textContent =
      `Status: ${j.status}\nLast: ${j.last}\nUSDT: ${j.usdt}\n` +
      `Profit Today: ${j.profit_today}\nProfit Yesterday: ${j.profit_yesterday}\n` +
      `PnL Cumulative: ${j.pnl_cumulative}\nProcessed Orders: ${j.processed_orders}\n`;

    // positions
    let pt = document.querySelector('#positionsTable tbody');
    pt.innerHTML = '';
    for (const [pair, pos] of Object.entries(j.positions)){
      let tr = `<tr><td>${pair}</td><td>${pos.entry||''}</td><td>${pos.qty||0}</td></tr>`;
      pt.innerHTML += tr;
    }

    // trades
    let tt = document.querySelector('#tradesTable tbody');
    tt.innerHTML = '';
    for (const t of j.trades){
      let tr = `<tr><td>${t.time}</td><td>${t.pair}</td><td>${t.side}</td><td>${t.qty}</td><td>${t.px}</td><td>${t.reason}</td></tr>`;
      tt.innerHTML += tr;
    }

    // logs
    let logDiv = document.getElementById('logBox');
    logDiv.textContent = j.scans.join("\n");
    logDiv.scrollTop = logDiv.scrollHeight;
  } catch(e){
    console.error(e);
  }
}

async function controlBot(cmd){
  try{
    const r = await fetch('/'+cmd, {method:'POST'});
    const j = await r.json();
    alert("Bot " + j.status);
  } catch(e){
    alert("Error: "+e);
  }
}

setInterval(refreshStatus, 5000);
refreshStatus();
</script>
</body>
</html>
