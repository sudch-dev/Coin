<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Market Maker Dashboard</title>
<style>
  :root {
    --bg:#0f141a; --panel:#18222b; --text:#e9eef4; --muted:#aab7c4; --accent:#66e0a3; --warn:#ffb86b; --bad:#ff6b6b;
    --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  }
  body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
  .wrap { max-width: 980px; margin: 28px auto; padding: 0 16px;}
  h1 { margin: 0 0 16px; font-size: 28px; }
  .badge { display:inline-block; padding:8px 12px; margin:6px 8px 18px 0; border-radius:999px; background:#212b35; color:#cfe7ff; font-size:14px;}
  .row { display:grid; grid-template-columns: 1fr; gap:18px; }
  @media(min-width:900px){ .row { grid-template-columns: 1fr 1fr; } }
  .card { background:var(--panel); border-radius:14px; padding:16px 16px; box-shadow: 0 0 0 1px rgba(255,255,255,.04) inset; }
  .card h2 { margin: 2px 0 14px; font-size: 22px; }
  .mono { font-family: var(--mono); white-space: pre-wrap; }
  .table { width:100%; border-collapse: collapse; font-family: var(--mono); font-size: 14px;}
  .table th, .table td { border-bottom: 1px solid rgba(255,255,255,.06); padding:10px 8px; text-align:left;}
  .muted { color: var(--muted); }
  .good { color: var(--accent); }
  .bad { color: var(--bad); }
  .btn { background:#263241; color:#eaf4ff; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px; cursor:pointer; }
  .foot { text-align:center; color:#8ea1b3; margin:26px 0 12px; font-size:13px;}
  .pill { display:inline-block; padding:3px 7px; border-radius:6px; background:#1f2a33; color:#a2bfd8; font-family:var(--mono); font-size:12px;}
</style>
</head>
<body>
<div class="wrap">
  <h1>Market Maker Dashboard</h1>
  <div>
    <span class="badge">TP: 0.5% · No SL</span>
    <span id="autoBadge" class="badge">Auto-scan: every 60s</span>
    <button id="runBtn" class="btn">Run Scan Now</button>
  </div>

  <div class="row">
    <div class="card">
      <h2>Signals & Decisions</h2>
      <div id="log" class="mono" style="font-size:14px; line-height:1.45; overflow:auto; max-height:420px;">loading…</div>
    </div>

    <div class="card">
      <h2>Balances</h2>
      <div id="balances" class="muted">loading…</div>
      <h2 style="margin-top:18px;">Open TP Orders</h2>
      <table class="table" id="tpTable">
        <thead><tr><th>Pair</th><th>Qty</th><th>Limit Px</th><th>Since</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Recent Trades</h2>
      <table class="table" id="trades">
        <thead><tr><th>Time</th><th>Pair</th><th>Side</th><th>Qty</th><th>Price</th><th>Realized</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>P&amp;L</h2>
      <div id="pnl" class="mono"></div>
      <h2 style="margin-top:18px;">Keepalive</h2>
      <div id="ka" class="mono"></div>
      <h2 style="margin-top:18px;">Errors</h2>
      <div id="err" class="mono muted">-</div>
    </div>
  </div>

  <div class="foot">© 2025 MM Bot · Logs update live every 10s.</div>
</div>

<script>
let pollMs = 10000;   // 10s
let timer = null;

async function fetchStatus() {
  try {
    const r = await fetch('/status');
    const j = await r.json();

    // logs
    const lines = (j.scans || []).map(s => s
      .replace('→ BUY', '→ BUY').replace('→ SELL', '→ SELL'));
    document.getElementById('log').textContent = (lines.length? lines.join('\n') : '—');

    // balances
    const coins = j.coins || {};
    const rows = Object.keys(coins).sort().map(k => `<tr><td>${k}</td><td>${(+coins[k]).toFixed(8)}</td></tr>`).join('');
    document.getElementById('balances').innerHTML =
      `<table class="table"><thead><tr><th>Coin</th><th>Qty</th></tr></thead><tbody>${rows}</tbody></table>
       <div style="margin-top:8px" class="mono">USDT: ${(j.usdt||0).toFixed(6)}</div>`;

    // open tp
    const tp = j.open_tp || [];
    document.querySelector('#tpTable tbody').innerHTML =
      tp.map(x => `<tr><td>${x.pair}</td><td>${(+x.qty).toFixed(8)}</td><td>${x.limit_px}</td><td>${new Date(x.since_ts*1000).toLocaleTimeString()}</td></tr>`).join('');

    // trades
    const trows = (j.trades||[]).map(t =>
      `<tr><td>${t.ts}</td><td>${t.pair}</td><td>${t.side}</td><td>${(+t.qty).toFixed(8)}</td><td>${t.price}</td><td>${t.realized??0}</td></tr>`).join('');
    document.querySelector('#trades tbody').innerHTML = trows || '<tr><td colspan="6" class="muted">No recent trades.</td></tr>';

    // pnl
    document.getElementById('pnl').textContent =
      `Today: ${j.profit_today}\nYesterday: ${j.profit_yesterday}\nCumulative: ${j.pnl_cumulative}`;

    // keepalive
    const ka = j.keepalive || {};
    document.getElementById('ka').textContent =
      `External Ping: ${ka.enabled? 'Enabled':'Disabled'}\nLast Ping (age): ${ka.last_ping_age_sec ?? '-'}s\nNext Due: ${ka.next_due_sec ?? '-'}s\nInterval: ${ka.interval_sec || '-'}s\nBase URL\n${ka.app_base_url || '-'}`;

    // error
    document.getElementById('err').textContent = j.error || '-';

  } catch (e) {
    document.getElementById('err').textContent = 'UI fetch error: ' + e;
  }
}

async function runNow(){
  // Touch /status forces loop info to appear; loop runs continuously.
  await fetchStatus();
}

document.getElementById('runBtn').addEventListener('click', runNow);

function startPolling(){
  if(timer) clearInterval(timer);
  timer = setInterval(fetchStatus, pollMs);
}
fetchStatus();
startPolling();
</script>
</body>
</html>
