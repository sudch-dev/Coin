<!DOCTYPE html>
<html>
<head>
    <title>CoinDCX Live EMA(5,10) Spot Scanner</title>
    <style>
        body { font-family: sans-serif; background: #f8fcfd; }
        #mainbox { background: #fff; width: 500px; margin: 40px auto; padding: 24px; border-radius: 12px; box-shadow: 0 2px 16px #0001; }
        button { padding: 8px 18px; font-size: 16px; margin: 4px; }
        .signal { color: #2196f3; }
        .buy { color: green; }
        .sell { color: red; }
        .log { font-family: monospace; background: #eef; padding: 6px; border-radius: 8px; margin-bottom: 7px; }
    </style>
</head>
<body>
    <div id="mainbox">
        <h3>CoinDCX Live EMA(5,10) Spot Scanner</h3>
        <button onclick="start()">START</button>
        <button onclick="stop()">STOP</button>
        <span style="margin-left:15px;">Status: <b id="status">Idle</b></span>
        <div style="margin:10px 0;">
            <b>USDT Balance:</b> <span id="usdt">{{ usdt }}</span><br>
            <b>Last update:</b> <span id="last"></span>
        </div>
        <hr>
        <div>
            <b>Recent Trades</b>
            <div id="trades"></div>
        </div>
        <div style="margin-top:15px;">
            <b>Live Scan Log</b>
            <div id="scans"></div>
        </div>
    </div>
<script>
function toIST(utcStr) {
    // utcStr in format "2025-08-06 03:31:52"
    let d = new Date(utcStr.replace(" ", "T") + "Z");
    d.setMinutes(d.getMinutes() + 330); // add 5*60 + 30 min
    let y = d.getFullYear();
    let m = (d.getMonth()+1).toString().padStart(2,"0");
    let da = d.getDate().toString().padStart(2,"0");
    let h = d.getHours().toString().padStart(2,"0");
    let mi = d.getMinutes().toString().padStart(2,"0");
    let s = d.getSeconds().toString().padStart(2,"0");
    return `${y}-${m}-${da} ${h}:${mi}:${s}`;
}
function extractTime(line) {
    // expects format: "YYYY-MM-DD HH:MM:SS | ...", returns IST-formatted
    let m = line.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/);
    if (m) {
        let ist = toIST(m[1]);
        return line.replace(m[1], ist);
    }
    return line;
}
function update() {
    fetch('/status').then(x => x.json()).then(d => {
        document.getElementById('status').innerText = d.status;
        document.getElementById('usdt').innerText = d.usdt;
        document.getElementById('last').innerText = toIST(d.last);
        let logs = "";
        d.scans.forEach(l => { logs += `<div class='log'>${extractTime(l)}</div>`; });
        document.getElementById('scans').innerHTML = logs;
        let tr = "";
        d.trades.forEach(t => {
            tr += `<div class='log'><b>${toIST(t.time)}</b> <span class="${t.side=='BUY'?'buy':'sell'}">${t.pair} ${t.side}</span> @ ${t.entry} (${t.msg})</div>`;
        });
        document.getElementById('trades').innerHTML = tr || "<i>No trades yet.</i>";
    });
}
function start() {
    fetch('/start', {method:"POST"}).then(x=>update());
}
function stop() {
    fetch('/stop', {method:"POST"}).then(x=>update());
}
setInterval(update, 2000); update();
</script>
</body>
</html>
