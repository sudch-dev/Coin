<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title> Live Monitor</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:#0f1115; --card:#151922; --muted:#8ea0b3; --fg:#e6edf3;
    --good:#15c47e; --bad:#ff6b6b; --warn:#e6b800; --accent:#5aa7ff;
  }
  *{box-sizing:border-box}
  body{margin:0; font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--fg)}
  header{display:flex; gap:16px; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid #202534}
  h1{margin:0; font-size:18px}
  .small{color:var(--muted); font-size:12px}
  .row{display:flex; flex-wrap:wrap; gap:16px; padding:16px}
  .card{background:var(--card); border:1px solid #202534; border-radius:10px; padding:14px; flex:1 1 320px; min-width:280px}
  .kvs{display:grid; grid-template-columns: 160px 1fr; gap:8px 12px}
  .kvs div:nth-child(odd){color:var(--muted)}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #2a3144; background:#0f1320}
  .ok{color:var(--good)} .err{color:var(--bad)} .warn{color:var(--warn)}
  button{all:unset; background:#1b2335; border:1px solid #2a3144; color:#dce7f7; padding:8px 12px; border-radius:8px; cursor:pointer}
  button:hover{outline:1px solid #3a485f}
  .btns{display:flex; gap:10px; flex-wrap:wrap}
  table{width:100%; border-collapse:collapse}
  th,td{padding:8px 10px; border-bottom:1px solid #22283a; text-align:left}
  th{color:#a7b6c8; font-weight:600}
  .num{text-align:right; font-variant-numeric:tabular-nums}
  .logs{height:260px; overflow:auto; background:#0f1320; border:1px solid #22283a; border-radius:8px; padding:10px; font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap}
  footer{padding:10px 16px; color:var(--muted); border-top:1px solid #202534; display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:840px){ .grid2{grid-template-columns:1fr} }
</style>
</head>
<body>

<header>
  <div>
    <h1>CoinDCX Bot — Live Monitor</h1>
    <div class="small">EMA/Donchian strategy · Asia/Kolkata time</div>
  </div>
  <div class="pill" id="hbPill">
    <span>Heartbeat:</span><strong id="hbText">—</strong>
  </div>
</header>

<div class="row">
  <div class="card">
    <h3>Status</h3>
    <div class="kvs">
      <div>Engine</div><div id="st"></div>
      <div>Last Update</div><div id="last"></div>
      <div>USDT Balance</div><div class="num" id="usdt">0.0</div>
      <div>Error</div><div id="err" class="small">—</div>
    </div>
    <div style="height:8px"></div>
    <div class="btns">
      <button id="startBtn">▶ Start</button>
      <button id="stopBtn">■ Stop</button>
      <button id="refreshBtn">↻ Refresh</button>
      <span class="small" id="nextPingNote"></span>
    </div>
  </div>

  <div class="card">
    <h3>P&amp;L</h3>
    <div class="kvs">
      <div>Today</div><div class="num" id="pnlToday">0.000000</div>
      <div>Yesterday</div><div class="num" id="pnlYday">0.000000</div>
      <div>Cumulative</div><div class="num" id="pnlCum">0.000000</div>
    </div>
  </div>

  <div class="card">
    <h3>Open Positions</h3>
    <table id="posTbl">
      <thead><tr><th>Pair</th><th>Side</th><th class="num">Qty</th><th class="num">Entry</th><th class="num">TP</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>Coin Balances</h3>
    <table id="balTbl">
      <thead><tr><th>Coin</th><th class="num">Balance</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3>Trade Log</h3>
    <div class="logs" id="trades">loading…</div>
  </div>

  <div class="card">
    <h3>Scan Log</h3>
    <div class="logs" id="scans">loading…</div>
  </div>
</div>

<footer>
  <div>Keep-alive: pings <code>/ping</code> from the server loop. This page also polls <code>/status</code> every <span id="pollSecs">3</span>s.</div>
  <div>Local time: <span id="localNow">—</span></div>
</footer>

<script>
const $ = (s)=>document.querySelector(s);
const fmt = (n, d=6)=> (typeof n==='number') ? n.toFixed(d) : n;
const POLL_MS = 3000;  // front-end polling for this dashboard
let lastStatusEpoch = 0;

async function postJSON(url){
  try{
    const r = await fetch(url, {method:'POST'});
    return await r.json();
  }catch(e){ return {error:String(e)} }
}
function setHeartbeat(epoch){
  // epoch is server-side UNIX seconds; show age and color
  if(!epoch){ $("#hbText").textContent = "—"; return; }
  const age = Math.max(0, Math.floor(Date.now()/1000 - epoch));
  $("#hbText").textContent = age + "s ago";
  const pill = $("#hbPill");
  pill.classList.remove("ok","warn","err");
  if(age <= 6) pill.classList.add("ok");
  else if(age <= 15) pill.classList.add("warn");
  else pill.classList.add("err");
}

function renderStatus(data){
  $("#st").textContent   = data.status || "—";
  $("#last").textContent = data.last || "—";
  $("#usdt").textContent = (data.usdt ?? 0).toFixed(6);
  $("#pnlToday").textContent = fmt(data.profit_today ?? 0);
  $("#pnlYday").textContent  = fmt(data.profit_yesterday ?? 0);
  $("#pnlCum").textContent   = fmt(data.pnl_cumulative ?? 0);
  $("#err").textContent  = data.error || "—";

  // positions
  const posT = $("#posTbl tbody");
  posT.innerHTML = "";
  const pos = data.positions || {};
  Object.keys(pos).forEach(pair=>{
    const p = pos[pair] || {};
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${pair}</td>
                    <td>${p.side||"—"}</td>
                    <td class="num">${fmt(parseFloat(p.qty||0),6)}</td>
                    <td class="num">${fmt(parseFloat(p.entry||0),6)}</td>
                    <td class="num">${fmt(parseFloat(p.tp||0),6)}</td>`;
    posT.appendChild(tr);
  });
  if(!Object.keys(pos).length){
    const tr=document.createElement("tr"); tr.innerHTML=`<td colspan="5" class="small">No open positions</td>`;
    posT.appendChild(tr);
  }

  // balances
  const balT = $("#balTbl tbody");
  balT.innerHTML = "";
  const coins = data.coins || {};
  const entries = Object.entries(coins).filter(([c,v])=> v && v>0).sort((a,b)=>b[1]-a[1]);
  if(entries.length===0){
    const tr=document.createElement("tr"); tr.innerHTML=`<td colspan="2" class="small">No coin balances</td>`;
    balT.appendChild(tr);
  }else{
    for(const [c,v] of entries){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${c}</td><td class="num">${fmt(v,8)}</td>`;
      balT.appendChild(tr);
    }
  }

  // logs
  $("#trades").textContent = (data.trades || []).join("\n") || "—";
  $("#scans").textContent  = (data.scans  || []).join("\n") || "—";

  // heartbeat
  if(typeof data.status_epoch === "number"){
    lastStatusEpoch = data.status_epoch;
    setHeartbeat(lastStatusEpoch);
  }
}

async function loadStatus(){
  try{
    const r = await fetch("/status", {cache:"no-store"});
    const data = await r.json();
    renderStatus(data);
  }catch(e){
    $("#err").textContent = "Dashboard fetch error: " + e;
  }
}

$("#startBtn").onclick = async ()=>{
  const res = await postJSON("/start");
  await loadStatus();
};
$("#stopBtn").onclick = async ()=>{
  const res = await postJSON("/stop");
  await loadStatus();
};
$("#refreshBtn").onclick = loadStatus;

function tick(){
  $("#localNow").textContent = new Date().toLocaleString();
}
setInterval(tick, 1000); tick();

$("#pollSecs").textContent = (POLL_MS/1000).toFixed(0);
setInterval(loadStatus, POLL_MS);
loadStatus();
</script>
</body>
</html>
