<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#000; --green:#16ff16; --red:#ff3b3b; --card:#0b0b0b; --border:#161616;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:16px; background:#000; color:var(--green);
      font-family: ui-monospace, Menlo, Monaco, "Courier New", monospace;}
    h1{margin:0 0 14px 0; color:var(--red); font-weight:800; letter-spacing:1px;}
    .grid{display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(320px,1fr));}
    .card{background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    button{background:transparent; color:var(--green); border:1px solid var(--green);
      padding:6px 10px; border-radius:8px; cursor:pointer}
    .kv{display:grid; grid-template-columns: 160px 1fr; gap:6px 10px}
    .k{color:var(--red)}
    .v{color:var(--green)}
    .neg{color:var(--red)!important}
    table{width:100%; border-collapse:collapse; margin-top:8px; font-size:13px}
    th,td{border:1px solid var(--border); padding:6px 8px}
    th{color:var(--red); background:#070707; text-align:left}
    .log{background:#020402; border:1px solid var(--border); border-radius:8px; padding:8px;
      max-height:420px; overflow:auto; font-size:12px}
    .log-line{white-space:pre; display:block; padding:3px 6px; border-radius:4px}
    .altA{background:rgba(22,255,22,0.05); color:var(--green)}
    .altB{background:rgba(255,59,59,0.06); color:var(--red)}
    .small{font-size:12px; opacity:.9}
    .err{background:#1a0000; border:1px solid #4a0000; color:#ff8a8a; padding:8px; border-radius:8px; display:none; margin-bottom:12px}
  </style>
</head>
<body>
  <h1>Dashboard</h1>

  <div id="err" class="err"></div>

  <div class="grid">
    <div class="card">
      <div class="row">
        <button onclick="hit('/start','POST')">Start</button>
        <button onclick="hit('/stop','POST')">Stop</button>
        <button onclick="loadAll(true)">Refresh</button>
        <span class="small" id="lastRefresh" style="margin-left:auto">—</span>
      </div>
      <div class="kv" style="margin-top:8px">
        <div class="k">Status</div><div class="v" id="status">—</div>
        <div class="k">Last</div><div class="v" id="last">—</div>
        <div class="k">USDT</div><div class="v" id="usdt">—</div>
        <div class="k">Balance age</div><div class="v" id="bal_age">—</div>
        <div class="k">Profit today</div><div class="v" id="profit_today">—</div>
        <div class="k">PnL cumulative</div><div class="v" id="pnl_cumulative">—</div>
      </div>
    </div>

    <div class="card">
      <div class="row"><div style="color:var(--red);font-weight:700">Open Positions</div></div>
      <div id="positions" class="small">no data</div>
    </div>

    <div class="card">
      <div class="row"><div style="color:var(--red);font-weight:700">Recent Trades</div></div>
      <div id="trades" class="log"></div>
    </div>

    <div class="card">
      <div class="row"><div style="color:var(--red);font-weight:700">Scan Log</div></div>
      <div id="scans" class="log"></div>
    </div>

    <div class="card">
      <div class="row"><div style="color:var(--red);font-weight:700">Raw I/O</div></div>
      <div id="io" class="log"></div>
    </div>
  </div>

  <script>
    const $$ = id => document.getElementById(id);
    const setErr = (msg)=>{ const el=$$("err"); if(msg){ el.textContent=msg; el.style.display="block"; } else { el.style.display="none"; } };

    async function hit(url, method="GET"){
      try{
        setErr("");
        const res = await fetch(url, {method});
        if(!res.ok) throw new Error(url+" -> "+res.status);
        await loadAll(true);
      }catch(e){ setErr(e.message); }
    }

    async function getJSON(url){
      const res = await fetch(url);
      if(!res.ok) throw new Error(url+" -> "+res.status);
      return res.json();
    }

    function nice(n){
      if(n===null||n===undefined) return "—";
      if(typeof n!=="number") return n;
      const a=Math.abs(n);
      if(a>=100000) return n.toLocaleString(undefined,{maximumFractionDigits:2});
      if(a>=1) return n.toLocaleString(undefined,{maximumFractionDigits:4});
      return n.toLocaleString(undefined,{maximumSignificantDigits:6});
    }

    function colorNum(el,val){
      el.textContent = nice(val);
      el.classList.remove("neg");
      if(typeof val==="number" && val<0) el.classList.add("neg");
    }

    function renderAltLog(id, lines){
      const el=$$(id);
      if(!lines || !lines.length){ el.innerHTML = '<div class="small">no data yet</div>'; return; }
      const frag = document.createDocumentFragment();
      lines.forEach((ln,i)=>{
        const d=document.createElement("div");
        d.className="log-line "+(i%2===0?"altA":"altB");
        d.textContent = ln;  // exact server log text
        frag.appendChild(d);
      });
      el.innerHTML="";
      el.appendChild(frag);
      el.scrollTop = el.scrollHeight;
    }

    function renderPositions(positions){
      const keys=Object.keys(positions||{});
      if(keys.length===0){ $$("positions").textContent="no open positions"; return; }
      let html='<table><thead><tr><th>Pair</th><th>Qty</th><th>Entry</th><th>Timestamp</th></tr></thead><tbody>';
      for(const k of keys){
        const v=positions[k];
        html+=`<tr><td>${k}</td><td>${nice(v.qty)}</td><td>${nice(v.entry)}</td><td>${v.ts}</td></tr>`;
      }
      html+='</tbody></table>';
      $$("positions").innerHTML=html;
    }

    async function loadStatus(){
      const data = await getJSON("/status");
      // exact field names from app.py
      $$("status").textContent = data.status;
      $$("last").textContent = data.last;
      $$("bal_age").textContent = data.balances_age_sec!=null ? (data.balances_age_sec+"s") : "—";
      colorNum($$("usdt"), data.usdt);
      colorNum($$("profit_today"), data.profit_today);
      colorNum($$("pnl_cumulative"), data.pnl_cumulative);

      renderPositions(data.positions);
      renderAltLog("trades", data.trades);
      renderAltLog("scans", data.scans);
    }

    async function loadIO(){
      const data = await getJSON("/io");
      renderAltLog("io", data.io);
    }

    async function loadAll(manual=false){
      try{
        setErr("");
        await Promise.all([loadStatus(), loadIO()]);
        const t=new Date();
        $$("lastRefresh").textContent="refreshed "+t.toLocaleTimeString();
      }catch(e){
        setErr(e.message);
      }
    }

    // Poll every 1000ms (fast)
    setInterval(loadAll, 1000);
    window.onload = ()=>loadAll(true);
  </script>
</body>
</html>
