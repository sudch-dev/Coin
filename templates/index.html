<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <style>
    body { background-color: #000; color: #0f0; font-family: monospace; margin:0; padding:0; }
    h1 { color:#0f0; text-align:center; padding:10px; background:#111; margin:0; }
    .section { margin:10px; padding:10px; background:#111; border-radius:6px; }
    .title { color:#f44; font-weight:bold; margin-bottom:5px; }
    .green { color:#0f0; } .red { color:#f44; }
    button { margin:2px; padding:4px 10px; font-family: monospace; }
    #scanlog div:nth-child(odd) { color:#0f0; }
    #scanlog div:nth-child(even) { color:#f44; }
    #iolist div:nth-child(odd) { color:#0f0; }
    #iolist div:nth-child(even) { color:#f44; }
  </style>
</head>
<body>
  <h1>Dashboard</h1>

  <div class="section">
    <button onclick="start()">Start</button>
    <button onclick="stop()">Stop</button>
    <button onclick="refresh()">Refresh</button>
    <span>Status: <span id="status" class="red">Idle</span></span> | 
    <span>Last: <span id="last" class="green">-</span></span> | 
    <span>Keepalive: <span id="keepalive" class="green">-</span></span>
  </div>

  <div class="section">
    <div class="title">Balances</div>
    USDT: <span id="usdt" class="green">-</span><br>
    Profit Today: <span id="profit_today">-</span><br>
    Profit Yesterday: <span id="profit_yesterday">-</span><br>
    Cumulative P&L: <span id="pnl_cumulative">-</span>
  </div>

  <div class="section">
    <div class="title">Open Positions</div>
    <pre id="positions">no open positions</pre>
  </div>

  <div class="section">
    <div class="title">Recent Trades</div>
    <pre id="trades">no data yet</pre>
  </div>

  <div class="section">
    <div class="title">Scan Log</div>
    <div id="scanlog" style="max-height:250px; overflow:auto;"></div>
  </div>

  <div class="section">
    <div class="title">Raw I/O</div>
    <div id="iolist" style="max-height:200px; overflow:auto;"></div>
  </div>

  <script>
    async function api(path, opts={}) {
      const r = await fetch(path, opts).catch(e => null);
      if (!r) return null;
      try { return await r.json(); } catch { return null; }
    }

    async function refresh() {
      const st = await api("/status");
      if (!st) return;
      document.getElementById("status").textContent = st.status || "Idle";
      document.getElementById("last").textContent = st.last || "-";
      document.getElementById("usdt").textContent = st.usdt || 0;
      document.getElementById("profit_today").textContent = st.profit_today || 0;
      document.getElementById("profit_yesterday").textContent = st.profit_yesterday || 0;
      document.getElementById("pnl_cumulative").textContent = st.pnl_cumulative || 0;
      document.getElementById("positions").textContent = JSON.stringify(st.positions,null,2) || "none";
      document.getElementById("trades").textContent = JSON.stringify(st.trades,null,2) || "none";

      const scans = document.getElementById("scanlog");
      scans.innerHTML = (st.scans||[]).map(x=>"<div>"+x+"</div>").join("");

      const io = await api("/io");
      const ioBox = document.getElementById("iolist");
      ioBox.innerHTML = (io||[]).map(x=>"<div>"+x+"</div>").join("");
    }

    async function keepaliveStatus() {
      const r = await fetch("/ping").catch(e=>null);
      document.getElementById("keepalive").textContent = r && r.ok ? "OK" : "FAIL";
      document.getElementById("keepalive").className = r && r.ok ? "green" : "red";
    }

    async function start(){ await api("/start",{method:"POST"}); refresh(); }
    async function stop(){ await api("/stop",{method:"POST"}); refresh(); }

    setInterval(refresh, 5000);
    setInterval(keepaliveStatus, 60000); // ping every 60s
    refresh(); keepaliveStatus();
  </script>
</body>
</html>
