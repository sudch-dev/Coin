<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#000;
      --fg-green:#16ff16;  /* primary green */
      --fg-red:#ff3b3b;    /* primary red */
      --fg-dim:#0aa00a;    /* dimmer green for body */
      --card:#0b0b0b;
      --border:#161616;
      --muted:#0c580c;
      --a1:#061006;
      --a2:#0b1d0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0; padding:18px;
      background:var(--bg);
      color:var(--fg-dim);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New", monospace;
      line-height:1.35;
    }
    h1{
      margin:0 0 16px 0;
      color:var(--fg-red);
      font-weight:800; letter-spacing:1px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      padding:14px;
      box-shadow:0 0 0 1px rgba(255,59,59,0.03), 0 8px 30px rgba(0,0,0,0.35);
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{
      background:transparent; color:var(--fg-green);
      border:1px solid var(--fg-green);
      padding:8px 12px; border-radius:8px;
      cursor:pointer; transition:.15s transform ease;
    }
    button:hover{transform:translateY(-1px); box-shadow:0 0 0 2px rgba(22,255,22,0.1) inset;}
    .pill{
      display:inline-block; padding:4px 8px; border-radius:999px;
      border:1px solid var(--border); background:#020302; color:var(--fg-green);
      font-size:12px; margin-left:6px;
    }
    .kv{display:grid; grid-template-columns: 160px 1fr; gap:6px 10px; align-items:baseline}
    .kv .k{color:var(--fg-red)}
    .kv .v{color:var(--fg-green)}
    .neg{color:var(--fg-red)!important}
    .pos{color:var(--fg-green)!important}

    table{width:100%; border-collapse:collapse; margin-top:8px; font-size:13px}
    th,td{border:1px solid var(--border); padding:6px 8px}
    th{color:var(--fg-red); background:#070707; text-align:left}

    /* log blocks */
    pre, .log{
      background:#020402; border:1px solid var(--border);
      border-radius:8px; padding:10px; max-height:420px; overflow:auto;
      font-size:12px; margin:8px 0 0 0;
    }
    .log-line{white-space:pre; display:block; padding:3px 6px; border-radius:4px}
    .altA{background:rgba(22,255,22,0.05); color:var(--fg-green)}  /* green line */
    .altB{background:rgba(255,59,59,0.06); color:var(--fg-red)}    /* red line */

    .tiny{font-size:12px; color:var(--muted)}
    .muted{opacity:.8}
    .spacer{height:6px}
    .badge{border:1px solid var(--border); padding:2px 6px; border-radius:6px; margin-left:6px}
    a{color:var(--fg-green); text-decoration:none; border-bottom:1px dotted var(--fg-green)}
    a:hover{opacity:.85}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <h1>Dashboard</h1>

  <div class="grid">
    <!-- Controls -->
    <div class="card">
      <div class="row">
        <button onclick="startBot()">Start</button>
        <button onclick="stopBot()">Stop</button>
        <button onclick="refreshNow()">Refresh</button>
        <span class="badge tiny">auto 1s</span>
        <span class="right pill tiny" id="lastRefresh">—</span>
      </div>
      <div class="spacer"></div>
      <div class="kv">
        <div class="k">Status</div><div class="v" id="status">—</div>
        <div class="k">Last tick</div><div class="v" id="last">—</div>
        <div class="k">USDT Balance</div><div class="v" id="usdt">—</div>
        <div class="k">Balance age</div><div class="v" id="bal_age">—</div>
        <div class="k">Profit today</div><div class="v" id="profit_today">—</div>
        <div class="k">PnL cumulative</div><div class="v" id="pnl_cumulative">—</div>
      </div>
    </div>

    <!-- Positions -->
    <div class="card">
      <div class="row">
        <div style="color:var(--fg-red); font-weight:700;">Open Positions</div>
      </div>
      <div id="positions"></div>
    </div>

    <!-- Trades -->
    <div class="card">
      <div class="row">
        <div style="color:var(--fg-red); font-weight:700;">Recent Trades</div>
        <span class="pill tiny">detailed</span>
      </div>
      <div id="trades" class="log"></div>
    </div>

    <!-- Scan log -->
    <div class="card">
      <div class="row">
        <div style="color:var(--fg-red); font-weight:700;">Scan Log</div>
        <span class="pill tiny">signals</span>
      </div>
      <div id="scans" class="log"></div>
    </div>

    <!-- Raw IO -->
    <div class="card">
      <div class="row">
        <div style="color:var(--fg-red); font-weight:700;">Raw I/O</div>
        <span class="pill tiny">requests &amp; responses</span>
      </div>
      <div id="io" class="log"></div>
    </div>
  </div>

  <script>
    const $$ = (id)=>document.getElementById(id);

    async function apiJSON(url, method="GET"){
      const res = await fetch(url, {method});
      if(!res.ok) throw new Error(url+" -> "+res.status);
      return res.json();
    }

    function niceNum(n){
      if(n === null || n === undefined) return "—";
      if(typeof n === "number"){
        const abs = Math.abs(n);
        if(abs>=100000) return n.toLocaleString(undefined,{maximumFractionDigits:2});
        if(abs>=1) return n.toLocaleString(undefined,{maximumFractionDigits:4});
        return n.toLocaleString(undefined,{maximumSignificantDigits:6});
      }
      return n;
    }

    function colorizeNumber(el, value){
      if(typeof value !== "number") { el.textContent = value; return; }
      el.textContent = niceNum(value);
      el.classList.remove("pos","neg");
      if(value > 0) el.classList.add("pos");
      else if(value < 0) el.classList.add("neg");
    }

    async function startBot(){ await apiJSON("/start","POST"); await loadAll(); }
    async function stopBot(){ await apiJSON("/stop","POST"); await loadAll(); }

    function refreshNow(){ loadAll(true); }

    function renderPositions(positions){
      const keys = Object.keys(positions||{});
      if(keys.length===0){
        $$("positions").innerHTML = '<div class="tiny">no open positions</div>';
        return;
      }
      let html = '<table><thead><tr><th>Pair</th><th>Qty</th><th>Entry</th><th>Timestamp</th></tr></thead><tbody>';
      for(const p of keys){
        const v = positions[p];
        html += `<tr>
          <td>${p}</td>
          <td>${niceNum(v.qty)}</td>
          <td>${niceNum(v.entry)}</td>
          <td>${v.ts}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      $$("positions").innerHTML = html;
    }

    function renderAltLog(containerId, lines){
      const el = $$(containerId);
      if(!lines || !lines.length){ el.innerHTML = '<div class="tiny">no data</div>'; return; }
      // Alternate colors line-by-line: altA (green) / altB (red)
      const frag = document.createDocumentFragment();
      lines.forEach((ln, i)=>{
        const div = document.createElement('div');
        div.className = 'log-line ' + (i % 2 === 0 ? 'altA' : 'altB');
        // emphasize BUY/SELL and Gates
        div.innerHTML = ln
          .replaceAll(' BUY ',' <b>BUY</b> ')
          .replaceAll(' SELL ',' <b>SELL</b> ')
          .replaceAll(' Gates: Buy=True',' <b>Gates: Buy=True</b>')
          .replaceAll(' Gates: Sell=True',' <b>Gates: Sell=True</b>');
        frag.appendChild(div);
      });
      el.innerHTML = '';
      el.appendChild(frag);
      // Auto-scroll to bottom
      el.scrollTop = el.scrollHeight;
    }

    async function loadStatus(){
      const data = await apiJSON("/status");
      // top stats
      $$("#status").textContent = data.status;
      $$("#last").textContent = data.last;
      $$("#bal_age").textContent = data.balances_age_sec != null ? (data.balances_age_sec + "s") : "—";
      colorizeNumber($$("#usdt"), data.usdt);
      colorizeNumber($$("#profit_today"), data.profit_today);
      colorizeNumber($$("#pnl_cumulative"), data.pnl_cumulative);

      // positions
      renderPositions(data.positions);

      // logs
      renderAltLog("trades", data.trades || []);
      renderAltLog("scans", data.scans || []);
    }

    async function loadIO(){
      const data = await apiJSON("/io");
      renderAltLog("io", data.io || []);
    }

    async function loadAll(manual=false){
      try{
        await Promise.all([loadStatus(), loadIO()]);
        const t = new Date();
        $$("#lastRefresh").textContent = "refreshed " + t.toLocaleTimeString();
        if(manual){
          // small visual bump
          $$("#lastRefresh").style.transform = "scale(1.05)";
          setTimeout(()=>{$$("#lastRefresh").style.transform="";},200);
        }
      }catch(err){
        console.error(err);
      }
    }

    // fast auto-refresh: every 1s to help “fast triggering”
    setInterval(loadAll, 1000);
    window.onload = () => loadAll(true);
  </script>
</body>
</html>
